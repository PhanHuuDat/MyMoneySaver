@page "/transactions"
@rendermode InteractiveServer
@using MyMoneySaver.Models
@using MyMoneySaver.Services
@inject TransactionService TransactionService
@inject CategoryService CategoryService
@inject IDialogService DialogService
@implements IDisposable

<PageTitle>Transactions - Money Tracker</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Money Tracker</MudText>

    <!-- Summary Cards -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" md="4">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.h6">Balance</MudText>
                    <MudText Typo="Typo.h4" Color="@GetBalanceColor()">
                        @FormatCurrency(_totalBalance)
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.h6">Income</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Success">
                        @FormatCurrency(_totalIncome)
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.h6">Expenses</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Error">
                        @FormatCurrency(_totalExpenses)
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Filters -->
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudSelect T="int?" Label="Category" @bind-Value="_filterCategoryId" Clearable>
                    @foreach (var cat in _categories)
                    {
                        <MudSelectItem Value="@cat.Id">@cat.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="TransactionType?" Label="Type" @bind-Value="_filterType" Clearable>
                    <MudSelectItem Value="@TransactionType.Income">Income</MudSelectItem>
                    <MudSelectItem Value="@TransactionType.Expense">Expense</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2">
                <MudDatePicker Label="Start Date" @bind-Date="_filterStartDate" Clearable />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudDatePicker Label="End Date" @bind-Date="_filterEndDate" Clearable />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           OnClick="ApplyFilters" FullWidth>
                    Filter
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Action Buttons -->
    <MudStack Row Class="mb-4" Justify="Justify.SpaceBetween">
        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                   OnClick="OpenAddDialog" StartIcon="@Icons.Material.Filled.Add">
            Add Transaction
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                   OnClick="OpenCategoryDialog" StartIcon="@Icons.Material.Filled.Category">
            Manage Categories
        </MudButton>
    </MudStack>

    <!-- Transaction Table -->
    <MudTable Items="@_filteredTransactions" Hover Dense>
        <HeaderContent>
            <MudTh>Date</MudTh>
            <MudTh>Category</MudTh>
            <MudTh>Description</MudTh>
            <MudTh>Type</MudTh>
            <MudTh>Amount</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Date.ToShortDateString()</MudTd>
            <MudTd>
                <MudChip T="string" Icon="@GetCategoryIcon(context.CategoryId)"
                         Style="@($"background-color: {GetCategoryColor(context.CategoryId)};")">
                    @GetCategoryName(context.CategoryId)
                </MudChip>
            </MudTd>
            <MudTd>@context.Description</MudTd>
            <MudTd>
                <MudChip T="string" Color="@(context.Type == TransactionType.Income ? Color.Success : Color.Error)">
                    @context.Type
                </MudChip>
            </MudTd>
            <MudTd>@FormatCurrency(context.Amount)</MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                               Size="Size.Small"
                               OnClick="@(() => OpenEditDialog(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Size="Size.Small" Color="Color.Error"
                               OnClick="@(() => DeleteTransaction(context.Id))" />
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudContainer>

@code {
    private List<Transaction> _filteredTransactions = new();
    private List<Category> _categories = new();

    private decimal _totalBalance;
    private decimal _totalIncome;
    private decimal _totalExpenses;

    // Filter fields
    private int? _filterCategoryId;
    private TransactionType? _filterType;
    private DateTime? _filterStartDate;
    private DateTime? _filterEndDate;

    protected override void OnInitialized()
    {
        // Subscribe to service events
        TransactionService.OnTransactionsChanged += HandleDataChanged;
        CategoryService.OnCategoriesChanged += HandleDataChanged;

        // Load initial data
        LoadData();
    }

    private void LoadData()
    {
        _categories = CategoryService.GetAll();
        ApplyFilters();
        CalculateSummary();
    }

    private void ApplyFilters()
    {
        _filteredTransactions = TransactionService.GetFiltered(
            _filterCategoryId,
            _filterStartDate,
            _filterEndDate,
            _filterType);
    }

    private void CalculateSummary()
    {
        _totalBalance = TransactionService.GetTotalBalance();
        _totalIncome = TransactionService.GetTotalIncome();
        _totalExpenses = TransactionService.GetTotalExpenses();
    }

    private void HandleDataChanged()
    {
        LoadData();
        StateHasChanged();
    }

    private async Task OpenAddDialog()
    {
        // TODO: Implement dialog (simplified for demo)
        var transaction = new Transaction();
        // Show dialog, get result
        // TransactionService.Add(transaction);
    }

    private async Task OpenEditDialog(Transaction transaction)
    {
        // TODO: Implement dialog
        // TransactionService.Update(transaction);
    }

    private async Task DeleteTransaction(int id)
    {
        // TODO: Add confirmation dialog
        TransactionService.Delete(id);
    }

    private async Task OpenCategoryDialog()
    {
        // TODO: Implement category management dialog
    }

    // Helper methods
    private string FormatCurrency(decimal amount) => $"${amount:N2}";
    private Color GetBalanceColor() => _totalBalance >= 0 ? Color.Success : Color.Error;
    private string GetCategoryName(int categoryId) =>
        _categories.FirstOrDefault(c => c.Id == categoryId)?.Name ?? "Unknown";
    private string GetCategoryIcon(int categoryId) =>
        _categories.FirstOrDefault(c => c.Id == categoryId)?.Icon ?? "category";
    private string GetCategoryColor(int categoryId) =>
        _categories.FirstOrDefault(c => c.Id == categoryId)?.Color ?? "#757575";

    public void Dispose()
    {
        TransactionService.OnTransactionsChanged -= HandleDataChanged;
        CategoryService.OnCategoriesChanged -= HandleDataChanged;
    }
}
